<html>
  <body style="margin: 0;">
    <script>
      function clone(x) {
        return JSON.parse(JSON.stringify(x))
      }

      function convertToServer(state) {
        var server = clone(state);
        Object.keys(server).map(function(key) {
          server[key] = {
            on_update: [
              server[key]
            ]
          }
        });

        return {
          manifest: server
        };
      }

      function addOutputsToServer(server, htmlsteps) {
        htmlsteps.map(function(htmlstep) {
          server.manifest[htmlstep] = {}
        })
      }
    </script>
    <script>
      var state = {};

      function onStart() {
      }

      async function onEnd(result, htmlsteps) {
        Object.assign(state, result);

        const body = convertToServer(state);
        addOutputsToServer(body, htmlsteps);

        console.log('Sending: \n' + JSON.stringify(body, null, 2));

        const resp = await fetch('eval', {
          method: 'POST',
          headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(body)
        });

        const updates = await resp.json();

        console.log('Receiving: \n' + JSON.stringify(updates, null, 2));

        var params = clone(updates);
        Object.keys(params).map(function(key) {
          params[key] = params[key].result;
        })
        // window.hal9.params = params;
      }

      function onError(error) {
        console.error(error);
      }

      const pipeline = {
        "steps": [],
        "params": {},
        "outputs": {},
        "scripts": {},
        "version": "0.0.1"
      }

      const localhost = window.location.origin.includes('localhost=true');

      const environment = localhost ? 'localhost' : 'devel';
      const libraries = {
        localhost: 'http://localhost:8000/dist/hal9.js',
        devel: 'https://cdn.jsdelivr.net/npm/hal9@0.2.86/dist/hal9.dev.js',
      }

      const render = function() {
        const el = document.getElementById('app')

        window.hal9.callbacks = {
          onStart: onStart,
          onEnd: onEnd,
          onError: onError
        };

        hal9.init({
          iframe: true,
          html: el,
          api: libraries[environment],
          editable: true,
          mode: 'design',
          pipeline: pipeline
        }, {}).then(function(hal9) {
          // OK
        });
      }

      const script = document.createElement('script');
      script.id = 'hal9-script';
      script.src = libraries[environment];
      document.body.appendChild(script);

      script.addEventListener('load', function() {
        render()
      });
    </script>
    <div style='width: 100%; height: 100%'>
      <div id='app'></div>
    </div>
  </body>
</html>
