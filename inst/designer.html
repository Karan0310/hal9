<html>
  <body style="margin: 0;">
    <script>
      function clone(x) {
        return JSON.parse(JSON.stringify(x))
      }

      function convertToServer(state) {
        var server = clone(state);
        Object.keys(server).map(function(key, index) {
          server[key] = {
            on_update: [
              server[key]
            ]
          }
        });

        return {
          manifest: server
        };
      }
    </script>
    <script>
      var state = {};
      function onStart() {
      }

      async function onEnd(result) {
        Object.assign(state, result);

        const resp = await fetch('/eval:object', {
          method: 'POST',
          headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(convertToServer(state))
        });

        const updates = await resp.json();
        console.log(updates);
      }

      function onError(error) {
        console.error(error);
      }

      window.hal9 = {
        pipeline: {
          "steps": [],
          "params": {},
          "outputs": {},
          "scripts": {},
          "version": "0.0.1"
        },
        callbacks: {
          onStart: onStart,
          onEnd: onEnd,
          onError: onError
        }
      }

      const localhost = window.location.origin.includes('127.0.0.1');
      const environment = localhost ? 'localhost' : 'devel';
      const libraries = {
        localhost: 'http://localhost:8080/hal9.notebook.js',
        devel: 'http://devel.hal9.com/hal9.notebook.js',
      }

      const script = document.createElement('script');
      script.id = 'hal9-script';
      script.src = libraries[environment];
      document.body.appendChild(script);
    </script>
    <div style='width: 100%; height: 100%'>
      <div id='app'></div>
    </div>
  </body>
</html>
